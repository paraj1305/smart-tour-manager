{% extends "layout.html" %}

{% block extra_css %}
<style>
.rich-editor {
    height: 180px;
    border: 1px solid #ced4da;
    border-radius: 6px;
}

.upload-box {
    border: 2px dashed #ced4da;
    border-radius: 6px;
    padding: 25px;
    text-align: center;
    cursor: pointer;
    position: relative;
}

.upload-box input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
}

.gallery-image-wrapper {
    position: relative;
}

.gallery-image-wrapper .remove-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background: rgba(255,0,0,0.7);
    border: none;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    cursor: pointer;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<section class="content-header px-1">
    <div class="container-fluid">
        <h1>{{ "Edit Tour Package" if package else "Create Tour Package" }}</h1>
        <hr>
    </div>
</section>

<section class="content">
<div class="container-fluid">
<div class="row justify-content-center">
<div class="col-lg-12">

<form
    id="tour-form"
    method="post"
    enctype="multipart/form-data"
    action="{% if package %}{{ url_for('tour_package_update', package_id=package.id) }}{% else %}{{ url_for('tour_package_create') }}{% endif %}"
    class="shadow-sm p-4 rounded bg-white border"
>

<div class="row">
    <!-- Title -->
    <div class="col-md-6 mb-3">
        <label class="form-label fw-semibold">Title</label>
        <input type="text"
               name="title"
               class="form-control"
               value="{{ package.title if package else '' }}">
    </div>

    <!-- Price with Currency -->
    <div class="col-md-6 mb-3">
        <label class="form-label fw-semibold">Price</label>

        <div class="input-group">
            <select name="currency" class="form-select" style="max-width: 100px;">
                {% for code, name in currencies %}
                    <option value="{{ code }}"
                        {% if package and package.currency == code %}
                            selected
                        {% endif %}>
                        {{ code }}
                    </option>
                {% endfor %}
            </select>

            <input type="number"
                   step="0.01"
                   name="price"
                   class="form-control"
                   value="{{ package.price if package else '' }}">
        </div>
    </div>
</div>

<div class="row">
<div class="col-md-6 mb-3">
    <label class="form-label fw-semibold">Country</label>
<select id="country"
        name="country"
        class="form-control select2">
    <option value="">Select Country</option>

    {% for country in countries %}
        <option value="{{ country }}"
            {% if package and package.country == country %}
                selected
            {% elif not package and loop.first %}
                selected
            {% endif %}>
            {{ country }}
        </option>
    {% endfor %}
</select>

</div>
    <!-- City -->
    <div class="col-md-6 mb-3">
        <label class="form-label fw-semibold">City</label>
        <input type="text" name="city" class="form-control" value="{{ package.city if package else '' }}">
    </div>
</div>

<!-- Description -->
<div class="mb-4">
    <label class="form-label fw-semibold">Description</label>
    <div id="description-editor" class="rich-editor"></div>
    <input type="hidden" name="description" id="description">
</div>

<!-- Itinerary -->
<div class="mb-4">
    <label class="form-label fw-semibold">Itinerary</label>
    <div id="itinerary-editor" class="rich-editor"></div>
    <input type="hidden" name="itinerary" id="itinerary">
</div>

<!-- Excludes -->
<div class="mb-4">
    <label class="form-label fw-semibold">Excludes</label>
    <div id="excludes-editor" class="rich-editor"></div>
    <input type="hidden" name="excludes" id="excludes">
</div>

<div class="col-md-12 mb-3">
    <label class="form-label fw-semibold">Assign Drivers</label>

    <select name="driver_ids"
            class="form-select select2"
            multiple
            data-placeholder="Select drivers">
        {% for driver in drivers %}
        <option value="{{ driver.id }}"
            {% if package and driver.id in assigned_driver_ids %}
                selected
            {% endif %}>
            {{ driver.name }} â€”
            {{ driver.vehicle_type }} {{driver.seats}} seats ({{ driver.vehicle_number }})
        </option>
        {% endfor %}
    </select>
</div>



<div class="row">
{% set cover_img = (
    package.gallery_images
    | selectattr("image_type", "equalto", "cover")
    | list
    | first
) if package and package.gallery_images else None %}

<div class="col-md-6 mb-4">
    <label class="form-label fw-semibold">Cover Image</label>

    <div class="upload-box">
        <input type="file" name="cover_image" id="coverImageInput" accept="image/*">
        <p>Drag & drop or click to upload</p>
    </div>

    {% if cover_img %}
        <img id="coverPreview"
             src="{{ url_for('static', path=cover_img.image_path) }}"
             class="img-thumbnail mt-2"
             width="150">
    {% else %}
        <img id="coverPreview"
             class="img-thumbnail mt-2 d-none"
             width="150">
    {% endif %}

</div>

    <!-- Gallery Images -->
 <div class="col-md-6 mb-4">
    <label class="form-label fw-semibold">Gallery Images</label>

    <div class="upload-box">
        <input type="file" name="gallery_images" id="galleryInput" accept="image/*" multiple>
        <p>Upload multiple images</p>
    </div>
<!-- Existing Images -->
<div id="existingGalleryWrapper" class="mt-3" style="display:none;">
    <h6>Existing Images</h6>
    <div id="existingGallery" class="d-flex gap-3 flex-wrap mt-3">

        {% if package and package.gallery_images %}
            {% for img in package.gallery_images %}
                {% if img.image_type == "gallery" %}
                <div class="gallery-image-wrapper">
                    <img src="{{ url_for('static', path=img.image_path) }}"
                         class="rounded border"
                         style="width:70px;height:70px;object-fit:cover;">

                    <button type="button"
                            class="remove-btn delete-db-image"
                            data-image-id="{{ img.id }}">
                        &times;
                    </button>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}

    </div>
</div>

<!-- New Images -->
<div id="newGalleryWrapper" class="mt-3" style="display:none;">
    <h6>New Images</h6>
    <div id="newGallery" class="d-flex gap-2 flex-wrap mt-2"></div>
</div>

</div>

<!-- Status -->
{% if package %}
<div class="mb-3">
    <label class="form-label fw-semibold">Status</label>
    <select name="status" class="form-select">
        <option value="active" {{ 'selected' if package.status == 'active' }}>Active</option>
        <option value="inactive" {{ 'selected' if package.status == 'inactive' }}>Inactive</option>
    </select>
</div>
{% endif %}

<!-- Submit -->
<div class="mt-4">
    <button type="submit" class="btn btn-submit">{{ "Update" if package else "Create" }}</button>
</div>

</form>

</div>
</div>
</div>
</section>
{% endblock %}

{% block extra_js %}
<script type="application/json" id="package-data">
{{ {
    "description": package.description if package else "",
    "itinerary": package.itinerary if package else "",
    "excludes": package.excludes if package else ""
} | tojson }}
</script>


<script>
$(document).ready(function () {
    $('#country').select2({
        placeholder: "Select country",
        allowClear: true,
        width: '100%'
    });
});

    $('.select2').select2({
        width: '100%',
        allowClear: true,
        placeholder: function(){
            return $(this).data('placeholder');
        }
    });

/* ======================
   QUILL EDITORS
====================== */
const descriptionEditor = new Quill('#description-editor', { theme: 'snow' });
const itineraryEditor = new Quill('#itinerary-editor', { theme: 'snow' });
const excludesEditor = new Quill('#excludes-editor', { theme: 'snow' });

const packageData = JSON.parse(
    document.getElementById("package-data").textContent
);

descriptionEditor.root.innerHTML = packageData.description || "";
itineraryEditor.root.innerHTML = packageData.itinerary || "";
excludesEditor.root.innerHTML = packageData.excludes || "";

/* ======================
   FORM SUBMIT
====================== */
$('#tour-form').on('submit', function () {
    $('#description').val(descriptionEditor.root.innerHTML);
    $('#itinerary').val(itineraryEditor.root.innerHTML);
    $('#excludes').val(excludesEditor.root.innerHTML);
});

/* ======================
   JQUERY VALIDATION
====================== */
const MAX_IMAGE_SIZE = 10 * 1024 * 1024; // 10 MB
let selectedGalleryFiles = [];

function showImageError(elementId, message) {
    const el = document.getElementById(elementId);
    el.textContent = message;
    el.classList.remove("d-none");

    setTimeout(() => {
        el.classList.add("d-none");
    }, 4000);
}


$("#tour-form").validate({
    rules: {
        title: { required: true, minlength: 3 },
        price: { required: true, number: true, min: 1 },
        city: { required: true },
        driver_ids: { required: true },
        cover_image: { required: {{ 'false' if package else 'true' }}, extension: "jpg|jpeg|png|gif", filesize: MAX_IMAGE_SIZE },
    },
    errorElement: "span",
    errorClass: "invalid-feedback",
    highlight: function (element) { $(element).addClass("is-invalid"); },
    unhighlight: function (element) { $(element).removeClass("is-invalid"); },
    errorPlacement: function (error, element) {
        error.insertAfter(element.closest('.upload-box').length ? element.closest('.upload-box') : element);
    }
});

/* ======================
   IMAGE PREVIEW
====================== */
// Cover image
$('#coverImageInput').on('change', function () {
    const file = this.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
        toastr.error("Please select a valid image file");
        this.value = "";
        return;
    }

    if (file.size > MAX_IMAGE_SIZE) {
        toastr.error("Cover image must be less than 10 MB");
        this.value = "";
        return;
    }

    const reader = new FileReader();
    reader.onload = e => {
        $('#coverPreview')
            .attr('src', e.target.result)
            .removeClass('d-none');
    };
    reader.readAsDataURL(file);
});


// Gallery preview
$(document).ready(function () {
    if ($('#existingGallery .gallery-image-wrapper').length > 0) {
        $('#existingGalleryWrapper').show();
    }
});

// Update visibility of headers
function updateGalleryHeaders() {
    $('#existingGalleryWrapper').toggle($('#existingGallery .gallery-image-wrapper').length > 0);
    $('#newGalleryWrapper').toggle($('#newGallery .gallery-image-wrapper').length > 0);
}

// Handle new gallery image selection
$('#galleryInput').on('change', function () {

    Array.from(this.files).forEach(file => {

        if (!file.type.startsWith('image/')) {
            toastr.error("Only image files are allowed");
            return;
        }

        if (file.size > MAX_IMAGE_SIZE) {
            toastr.error("Some images were skipped because they exceed the 10 MB size limit");
            
            return;
        }

        if (selectedGalleryFiles.some(f => f.name === file.name)) return;

        selectedGalleryFiles.push(file);

        const reader = new FileReader();
        reader.onload = e => {
            $('#newGallery').append(`
                <div class="gallery-image-wrapper" data-name="${file.name}">
                    <img src="${e.target.result}"
                         class="rounded border"
                         style="width:70px;height:70px;object-fit:cover;">
                    <button type="button"
                            class="remove-btn remove-new-image">
                        &times;
                    </button>
                </div>
            `);
            updateGalleryHeaders();
        };
        reader.readAsDataURL(file);
    });

    syncGalleryInput();
});


// Remove new images
$('#newGallery').on('click', '.remove-new-image', function () {
    const wrapper = $(this).closest('.gallery-image-wrapper');
    const fileName = wrapper.data('name');

    selectedGalleryFiles = selectedGalleryFiles.filter(f => f.name !== fileName);
    wrapper.remove();
    syncGalleryInput();
    updateGalleryHeaders();
});

// Delete existing DB images
// $('#existingGallery').on('click', '.delete-db-image', function () {
//     const btn = $(this);
//     const imageId = btn.data('image-id');

//     if (!confirm("Delete this image permanently?")) return;

//     $.ajax({
//         url: `/tour-packages/gallery-image/${imageId}/delete`,
//         type: 'POST',
//         success: function () {
//             btn.closest('.gallery-image-wrapper').fadeOut(200, function () {
//                 $(this).remove();
//                 updateGalleryHeaders();
//             });
//         },
//         error: function () {
//             alert("Failed to delete image");
//         }
//     });
// });

$('#existingGallery').on('click', '.delete-db-image', function () {

    const btn = $(this);
    const imageId = btn.data('image-id');

    confirmDelete(
        `/tour-packages/gallery-image/${imageId}/delete`,
        "Do you really want to delete this image permanently?",
        "POST",
        function () {
            btn.closest('.gallery-image-wrapper')
                .fadeOut(200, function () {
                    $(this).remove();
                    updateGalleryHeaders();
                });
        }
    );

});


// Sync selected files to input for form submission
function syncGalleryInput() {
    const dt = new DataTransfer();
    selectedGalleryFiles.forEach(file => dt.items.add(file));
    document.getElementById('galleryInput').files = dt.files;
    updateGalleryHeaders();
}

// Initial call for page load
updateGalleryHeaders();
</script>
{% endblock %}
