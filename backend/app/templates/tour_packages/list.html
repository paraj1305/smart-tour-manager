{% extends "layout.html" %}

{% block content %}
<section class="content-header px-1">
    <div class="container-fluid ">

        <!-- Heading + Search + Add Button -->
        <div class="row align-items-center g-2 mb-3">

            <div class="tour-packages-header d-flex align-items-center">
                <!-- Heading -->
                <h1 class="mb-0">My Tour Packages</h1>

                <!-- Live Search -->
                <input type="text" id="live-search" class="form-control" placeholder="Search by title, city, country..."
                    value="{{ search }}">

                <input type="date"
                    id="availability-date"
                    class="form-control"
                    value="{{ travel_date }}">

                <!-- Add Button -->
                <a href="{{ url_for('tour_package_create_page') }}" class="btn btn-submit">
                    Add Tour Package
                </a>

            </div>


        </div>

        <hr>



    </div>
</section>

<section class="content">
    <div class="container-fluid py-4">
        <!-- Table Container -->
        <div id="table-container">
            {% include "tour_packages/_table.html" %}
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    $(document).on('click', '.confirm-tour-delete', function (e) {
        e.preventDefault();

        confirmDelete(
            $(this).data('route'),
            'Are you sure you want to delete this tour package?',
            'POST',
            function () {
                location.reload();
            }
        );
    });

        // ---------------- SEARCH + DATE FILTER ----------------
    const searchInput = document.getElementById("live-search");
    const dateInput = document.getElementById("availability-date");
    const tableContainer = document.getElementById("table-container");

    let searchTimer = null;

    function loadTours() {
        const params = new URLSearchParams();

        if (searchInput.value.trim()) {
            params.append("search", searchInput.value.trim());
        }

        if (dateInput.value) {
            params.append("travel_date", dateInput.value);
        }

        fetch(`?${params.toString()}`, {
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => response.text())
        .then(html => {
            tableContainer.innerHTML = html;
        })
        .catch(err => console.error("Filter error:", err));
    }

    // ðŸ” Live search (debounced)
    searchInput.addEventListener("keyup", function () {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(loadTours, 400);
    });

    // ðŸ“… Date change
    dateInput.addEventListener("change", function () {
        loadTours();
    });

let availabilityPicker = null;
let selectedPackageId = null;

$(document).on('click', '.check-availability-btn', function () {

    selectedPackageId = $(this).data('package-id');
    const title = $(this).data('package-title');

    $('#availabilityTitle').text(`Availability â€“ ${title}`);

    const modalEl = document.getElementById('availabilityModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    modalEl.addEventListener('shown.bs.modal', function () {

        // Destroy previous picker
        if (availabilityPicker) {
            availabilityPicker.destroy();
            availabilityPicker = null;
        }

        // Init flatpickr
        availabilityPicker = flatpickr(
            document.getElementById('availabilityCalendar'),
            {
                inline: true,
                dateFormat: "Y-m-d",
                minDate: "today",
                disableMobile: true,
                onReady: function(selectedDates, dateStr, instance) {
                    instance.calendarContainer.classList.add('custom-flatpickr');
                },

                // âœ… AUTO REDIRECT ON DATE SELECT
                onChange: function (selectedDates, dateStr) {

                    // Set values
                    document.getElementById('auto_package_id').value = selectedPackageId;
                    document.getElementById('auto_travel_date').value = dateStr;

                    // Submit form
                    document.getElementById('autoBookingForm').submit();
                }
            }
        );

        // Fetch booked dates
        fetch(`/manual-bookings/booked-dates/${selectedPackageId}`)
            .then(res => res.json())
            .then(data => {
                const bookedDates = Array.isArray(data.booked_dates)
                    ? data.booked_dates
                    : [];

                availabilityPicker.set('disable', bookedDates);
            })
            .catch(err => {
                console.error("Error fetching booked dates:", err);
            });

    }, { once: true });
});
</script>
{% endblock %}