{% extends "layout.html" %}

{% block content %}
<section class="content-header px-1">
    <div class="container-fluid">
        <h1>{{ "Edit Manual Tour Booking" if booking else "Manual Tour Booking" }}</h1>
        <hr>
    </div>
</section>

<section class="content">
    <div class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-lg-12">

                <form id="manual-booking-form" method="post" action="{% if booking %}
                {{ request.url_for('manual_booking_update', booking_id=booking.id) }}
              {% else %}
                {{ request.url_for('manual_booking_create') }}
              {% endif %}" class="shadow-sm p-4 rounded bg-white border" novalidate>

                    <!-- ================= GUEST DETAILS ================= -->
                    <h5 class="mb-3 fw-semibold manual-booking-title">Guest Details</h5>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Select Customer</label>
                            <select id="customer_select" class="form-select" style="width:100%"></select>
                        </div>
                        <div class="col-md-6  mb-3">
                            <label class="form-label fw-semibold">Guest Name</label>
                            <input type="text" name="guest_name" class="form-control"
                                value="{{ booking.customer.guest_name if booking else '' }}">
                        </div>

                        <div class="col-md-6 col-lg-4 mb-3">
                            <label class="form-label fw-semibold">Phone Number</label>

                            <div class="input-group">
                                <select name="country_code" id="country_code" class="form-select"
                                    style="max-width:110px;">
                                    {% for code,name in country_codes %}
                                    <option value="{{ code }}" {% if booking and booking.customer.country_code==code %}
                                        selected {% endif %}>
                                        {{ code }}
                                    </option>
                                    {% endfor %}
                                </select>

                                <input type="text" name="phone" class="form-control"
                                    value="{{ booking.customer.phone if booking else '' }}" placeholder="Phone number">
                            </div>
                        </div>


                        <div class="col-md-6 col-lg-4 mb-3">
                            <label class="form-label fw-semibold">Email</label>
                            <input type="email" name="email" class="form-control"
                                value="{{ booking.customer.email if booking else '' }}">
                        </div>

                        <div class="col-md-12 col-lg-4 mb-3">
                            <label class="form-label fw-semibold">Passengers</label>

                            <div class="input-group">
                                <span class="input-group-text">Adults</span>
                                <input type="number" name="adults" class="form-control"
                                    value="{{ booking.adults if booking else 1 }}" min="1">

                                <span class="input-group-text">Kids</span>
                                <input type="number" name="kids" class="form-control"
                                    value="{{ booking.kids if booking else 0 }}" min="0">
                            </div>
                        </div>

                    </div>

                    <!-- ================= TOUR DETAILS ================= -->
                    <h5 class="mt-4 mb-3 fw-semibold manual-booking-title">Tour Details</h5>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Tour Package</label>

                            <select name="tour_package_id" class="form-select select2" {% if selected_package
                                %}disabled{% endif %} data-placeholder="Search tour package">
                                <option value=""></option>
                                {% for package in packages %}
                                <option value="{{ package.id }}" {% if booking and booking.tour_package_id==package.id
                                    %}selected{% endif %} {% if selected_package and package.id==selected_package.id
                                    %}selected{% endif %}>
                                    {{ package.title }} - {{ package.currency }} {{ package.price }}
                                </option>
                                {% endfor %}
                            </select>

                            {% if selected_package %}
                            <input type="hidden" name="tour_package_id" value="{{ selected_package.id }}">
                            {% endif %}
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-semibold">Travel Date</label>
                            <input type="date" name="travel_date" class="form-control"
                                value="{{ booking.travel_date if booking else '' }}">
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-semibold">Travel Time</label>
                            <input type="time" name="travel_time" class="form-control time-picker"
                                value="{{ booking.travel_time if booking else '' }}">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showAllDrivers">
                                <label class="form-check-label fw-semibold" for="showAllDrivers">
                                    Show other drivers
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row">

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Driver</label>
                            <select name="driver_id" class="form-select select2" data-placeholder="Search driver">
                                <option value=""></option>
                                {% for driver in drivers %}
                                <option value="{{ driver.id }}" {% if booking and booking.driver_id==driver.id
                                    %}selected{% endif %}>
                                    {{ driver.name }} â€”
                                    {{ driver.vehicle_type }} {{driver.seats}} seats ({{ driver.vehicle_number }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Pickup Location</label>
                            <input type="text" name="pickup_location" class="form-control"
                                value="{{ booking.pickup_location if booking else '' }}">
                        </div>
                    </div>

                    <!-- ================= PAYMENT DETAILS ================= -->
                    <h5 class="mt-4 mb-3 fw-semibold manual-booking-title">Payment Details</h5>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Total Amount</label>
                            <input type="number" step="0.01" name="total_amount" class="form-control"
                                value="{{ booking.total_amount if booking else '' }}">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Advance Paid</label>
                            <input type="number" step="0.01" name="advance_amount" class="form-control"
                                value="{{ booking.advance_amount if booking else 0 }}">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Remaining Amount</label>
                            <input type="number" step="0.01" name="remaining_amount" class="form-control" readonly
                                value="{{ booking.remaining_amount if booking else '' }}">
                        </div>
                    </div>

                    <div class=" page-bottom-action-btn  mt-4">
                        <button type="submit" class="btn btn-submit">
                            {{ "Update Booking" if booking else "Book Tour" }}
                        </button>
                        <a href="{{ request.url_for('manual_booking_list') }}" class="btn btn-cancel ms-2">Cancel</a>
                    </div>

                </form>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}

<script>
    $(document).ready(function () {
        /* Validation */
        $("#manual-booking-form").validate({
            rules: {
                guest_name: { required: true },
                country_code: { required: true },
                phone: { required: true, minlength: 7, maxlength: 15 },
                email: { email: true },  // optional, only check format
                adults: { required: true, min: 1 },
                kids: { required: true, min: 0 },
                pickup_location: { required: true },
                tour_package_id: { required: true },
                travel_date: { required: true },
                total_amount: { required: true, number: true },
                advance_amount: { number: true }
            },
            errorElement: "span",
            errorClass: "invalid-feedback",
            highlight: e => $(e).addClass("is-invalid"),
            unhighlight: e => $(e).removeClass("is-invalid"),
            errorPlacement: function (error, element) {
                if (element.parent().hasClass('input-group')) {
                    error.insertAfter(element.parent());
                } else {
                    error.insertAfter(element);
                }
            }
        });

        $('.select2').select2({
            width: '100%',
            allowClear: true
        });

        // customer ajax select2 (MUST be separate)
        $('#customer_select').select2({
            width: '100%',
            placeholder: "Search customer by name / phone",
            allowClear: true,
            minimumInputLength: 1,
            ajax: {
                url: "{{ url_for('customer_search') }}",
                dataType: 'json',
                delay: 300,
                data: function (params) {
                    return { q: params.term };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                }
            }
        });


        // Autofill on select
        $('#customer_select').on('select2:select', function (e) {
            const data = e.params.data;

            $('[name="guest_name"]').val(data.guest_name);
            $('[name="email"]').val(data.email || '');
            $('[name="phone"]').val(data.phone);
            $('[name="country_code"]').val(data.country_code).trigger('change');
        });

        // Clear fields if customer removed
        $('#customer_select').on('select2:clear', function () {
            $('[name="guest_name"]').val('');
            $('[name="email"]').val('');
            $('[name="phone"]').val('');
        });

        const packageSelect = $('[name="tour_package_id"]');

        if (!packageSelect.val()) {
            const firstOption = packageSelect.find('option[value!=""]').first().val();

            if (firstOption) {
                packageSelect.val(firstOption).trigger('change');
            }
        }
        const PREFILLED_TRAVEL_DATE = "{{ travel_date or '' }}";
        const CURRENT_BOOKING_DATE = "{{ booking.travel_date if booking else '' }}";

        const travelInput = document.querySelector('[name="travel_date"]');
        let isFirstLoad = true;

        const travelDatePicker = flatpickr(travelInput, {
            dateFormat: "Y-m-d",
            minDate: "today",
            disableMobile: true,
            allowInput: true,
            defaultDate: travelInput.value || null
        });

        if (PREFILLED_TRAVEL_DATE) {
            travelDatePicker.setDate(PREFILLED_TRAVEL_DATE, true);
        }

        setTimeout(() => {
            const packageId = $('[name="tour_package_id"]').val();
            const travelDate = $('[name="travel_date"]').val();

            if (packageId && travelDate) {
                applyBookedDates(packageId);
                loadAvailableDrivers();
            }
        }, 300);

        function applyBookedDates(packageId) {
            fetch(`/manual-bookings/booked-dates/${packageId}`)
                .then(res => res.json())
                .then(data => {
                    let disabledDates = data.booked_dates || [];

                    if (CURRENT_BOOKING_DATE) {
                        disabledDates = disabledDates.filter(
                            d => d !== CURRENT_BOOKING_DATE
                        );
                    }

                    travelDatePicker.set('disable', disabledDates);

                    if (isFirstLoad && PREFILLED_TRAVEL_DATE) {
                        travelDatePicker.setDate(PREFILLED_TRAVEL_DATE, true);
                    }

                    isFirstLoad = false;
                });
        }

        $('[name="tour_package_id"]').on('change', function () {
            const packageId = $(this).val();
            if (!packageId) return;

            if (!$('#showAllDrivers').is(':checked')) {
                applyBookedDates(packageId);
            } else {
                travelDatePicker.set('disable', []);
            }
        });

        $('#showAllDrivers').on('change', function () {
            const packageId = $('[name="tour_package_id"]').val();
            if (!packageId) return;

            if (this.checked) {
                travelDatePicker.set('disable', []);
            } else {
                applyBookedDates(packageId);
            }

            loadAvailableDrivers();
        });

function loadAvailableDrivers() {
    const packageId = $('[name="tour_package_id"]').val();
    const travelDate = $('[name="travel_date"]').val();
    const driverSelect = $('[name="driver_id"]');

    if (!packageId || !travelDate) return;

    const url = $('#showAllDrivers').is(':checked')
        ? `/manual-bookings/all-drivers/${packageId}/${travelDate}`
        : `/manual-bookings/available-drivers/${packageId}/${travelDate}`;

    const currentDriver = {
        id: "{{ booking.driver.id if booking and booking.driver else '' }}",
        text: "{{ booking.driver.name if booking and booking.driver else '' }} â€” {{ booking.driver.vehicle_type if booking and booking.driver else '' }} {{ booking.driver.seats if booking and booking.driver else '' }} seats ({{ booking.driver.vehicle_number if booking and booking.driver else '' }})"
    };

    fetch(url)
        .then(res => res.json())
        .then(data => {
            driverSelect.empty().append('<option value=""></option>');

            let found = false;

            data.forEach(d => {
                const selected = currentDriver.id == d.id;
                if (selected) found = true;

                driverSelect.append(
                    `<option value="${d.id}" ${selected ? 'selected' : ''}>
                        ${d.name} â€” ${d.vehicle_type} ${d.seats} seats (${d.vehicle_number})
                    </option>`
                );
            });

            // ðŸ”¥ If editing & current driver not in API â†’ force inject
            if (currentDriver.id && !found) {
                const option = new Option(
                    currentDriver.text,
                    currentDriver.id,
                    true,
                    true
                );
                driverSelect.append(option);
            }

            driverSelect.trigger('change.select2');
        });
}


        $('[name="tour_package_id"], [name="travel_date"]').on(
            'change',
            loadAvailableDrivers
        );

        function calculateRemaining() {
            const total = parseFloat($('[name="total_amount"]').val()) || 0;
            const advance = parseFloat($('[name="advance_amount"]').val()) || 0;
            $('[name="remaining_amount"]').val(
                Math.max(total - advance, 0).toFixed(2)
            );
        }

        $('[name="total_amount"], [name="advance_amount"]').on(
            "input",
            calculateRemaining
        );

        $(document).ready(function () {
            calculateRemaining();
        });
    });
</script>
{% endblock %}